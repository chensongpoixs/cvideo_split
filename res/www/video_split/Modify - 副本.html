
<html>
    <head>
        <meta name="viewport" content="width=device-width" />
        <title>视频拼接</title>
        <link href="js/layui/css/layui.css" rel="stylesheet" />
        <link href="js/plugins/font-awesome/css/font-awesome.css" rel="stylesheet" />
        <style>
            body {
                width: 2070px;
                /*height: 610px;*/
                margin: 5px auto;
                overflow-x: hidden;
            }
    
            * {
                padding: 0;
                margin: 0;
            }
    
            .layui-form-label {
                width: 84px;
                padding: 8px 5px;
            }
    
            ul li {
                border: 1px solid #E0E0E0;
                width: 440px;
                float: left;
                height: 278px;
                margin: 0 3px 5px 0;
            }
    
            .layui-form-item .layui-inline {
                margin-right: 0px;
            }
    
            .inputclass {
                width: 160px
            }
    
            .layui-form-item .layui-input-inline {
                width: 170px;
            }
    
            .layui-layer-title {
                height: 34px;
                line-height: 36px;
            }
        </style>
    </head>
    <body>
        <div class="layui-row">
            <div class="layui-form">
                <div class="layui-col-xs6" style="width:552px;">
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label">拼接通道名称</label>
                            <div class="layui-input-inline">
                                <input type="text" name="Tname" id="Tname" autocomplete="off" class="layui-input inputclass">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">拼接方向</label>
                            <div style="float:left;width:170px;">
                                <select name="direction" id="direction" lay-filter="direction">
                                    <option value="1">左右拼接</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label">拼接通道ID</label>
                            <div class="layui-input-inline">
                                <input type="tel" name="TID" id="TID" autocomplete="off" class="layui-input inputclass" readonly>
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">拼接方式</label>
                            <div style="float:left;width:170px;">
                                <select name="style" id="style" lay-filter="style">
                                    <option value="2">二拼一</option>
                                    <option value="3">三拼一</option>
                                    <option value="4">四拼一</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label">组播地址</label>
                            <div class="layui-input-inline">
                                <input type="tel" name="playAdd" id="playAdd" autocomplete="off" class="layui-input inputclass" value="239.1.0.16" readonly>
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">锁定1080P</label>
                            <div class="layui-input-inline">
                                <div style="float:left;width:170px;">
                                    <select name="islock" id="islock" lay-filter="islock">
                                        <option value="1">是</option>
                                        <option value="0">否</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label">组播端口</label>
                            <div class="layui-input-inline">
                                <input type="tel" name="playPort" id="playPort" autocomplete="off" class="layui-input inputclass" readonly>
                            </div>
                        </div>
                        <div class="layui-inline" style="margin-left:50px;">
                                <button id="ModifyOSD" class="layui-btn layui-btn-normal" onclick="ModifyOSDsTYLE();">编辑OSD</button>
                                <button id="BtnOSDOK" class="layui-btn layui-btn-normal"  onclick="SendOSD();"> 确定</button>
                            </div>
                    </div>
                    <div style="margin-top:35px;">
                        <div class="layui-form-item">
                            <label class="layui-form-label">拼接输出效果</label>
                            <label class="layui-form-label">宽度</label>
                            <div class="layui-input-inline" style="width: 70px;">
                                <input type="text" name="pj_width" id="pj_width" autocomplete="off" class="layui-input">
                            </div>
                            <div class="layui-form-mid" style="margin-left:25px;">高度</div>
                            <div class="layui-input-inline" style="width: 70px;">
                                <input type="text" name="pj_height" id="pj_height" autocomplete="off" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-form-item" style="position: relative;margin-left: 20px;border: 0px;">
                            <div id="osd" style="position:absolute;background: #767272;display: none;"> 
                                <span contenteditable="true" id="txtOSD" style="font-size: 20px;color: #fff; padding: 0 20px;">添加OSD效果</span>
                       </div>
                            <canvas id="playCanvas" style="width:520px;height: 260px; background:#FAFAFA;z-index: -1;">
                            </canvas>
                        </div>
                    </div>
                </div>
                <div class="layui-col-xs6">
                    <ul>
                        <li>
                            <div style="width:100%;line-height:50px;">
                                <span style="padding-left:10px;">摄像机1</span>
                                <div class="layui-input-inline">
                                    <div style="float:left;width:110px;">
                                        <select name="videoName1" id="videoName1" lay-filter="videoName1">
                                        </select>
                                    </div>
                                </div>
                                <span style="padding-left:3px;">上</span>
                                <div class="layui-input-inline">
                                    <div style="float:left;width:40px;">
                                        <input type="text" name="up1" id="up1" autocomplete="off" class="layui-input" oninput="ChangeUp1(this,1);" />
                                    </div>
                                </div>
                                <span style="padding-left:3px;">下</span>
                                <div class="layui-input-inline">
                                    <div style="float:left;width:40px;">
                                        <input type="text" name="down1" id="down1" autocomplete="off" class="layui-input" oninput="ChangeDown1(this,1);" />
                                    </div>
                                </div>
                                <span style="padding-left:3px;">左</span>
                                <div class="layui-input-inline">
                                    <div style="float:left;width:40px;">
                                        <input type="text" name="left1" id="left1" autocomplete="off" class="layui-input" oninput="ChangeLeft1(this,1);" />
                                    </div>
                                </div>
                                <span style="padding-left:3px;">右</span>
                                <div class="layui-input-inline">
                                    <div style="float:left;width:40px;">
                                        <input type="text" name="right1" id="right1" autocomplete="off" class="layui-input" oninput="ChangeRight1(this,1);" />
                                    </div>
                                </div>
                            </div>
                            <div style="width:100%;text-align:center;">
                                <div id="container1">
                                    <div id="imgDiv1" style="width:95%;margin:0px auto 10px;"></div>
                                    <div id="clipImgDiv1"></div>
                                </div>
                            </div>
                            <input type="hidden" id="cropImageHeight1" value="180" />
                            <input type="hidden" id="cropImageWidth1" value="180" />
                        </li>
                        <li>
                            <div style="width:100%;line-height:50px;">
                                <span style="padding-left:10px;">摄像机2</span>
                                <div class="layui-input-inline">
                                    <div style="float:left;width:110px;">
                                        <select name="videoName2" id="videoName2" lay-filter="videoName2">
                                        </select>
                                    </div>
                                </div>
                                <span style="padding-left:3px;">上</span>
                                <div class="layui-input-inline">
                                    <div style="float:left;width:40px;">
                                        <input type="text" name="up2" id="up2" autocomplete="off" class="layui-input" oninput="ChangeUp1(this,2);" />
                                    </div>
                                </div>
                                <span style="padding-left:3px;">下</span>
                                <div class="layui-input-inline">
                                    <div style="float:left;width:40px;">
                                        <input type="text" name="down2" id="down2" autocomplete="off" class="layui-input" oninput="ChangeDown1(this,2);" />
                                    </div>
                                </div>
                                <span style="padding-left:3px;">左</span>
                                <div class="layui-input-inline">
                                    <div style="float:left;width:40px;">
                                        <input type="text" name="left2" id="left2" autocomplete="off" class="layui-input" oninput="ChangeLeft1(this,2);" />
                                    </div>
                                </div>
                                <span style="padding-left:3px;">右</span>
                                <div class="layui-input-inline">
                                    <div style="float:left;width:40px;">
                                        <input type="text" name="right2" id="right2" autocomplete="off" class="layui-input" oninput="ChangeRight1(this,2);" />
                                    </div>
                                </div>
                            </div>
                            <div style="width:100%;text-align:center;">
                                <div id="container2">
                                    <div id="imgDiv2" style="width:95%;margin:0px auto 10px;"></div>
                                    <div id="clipImgDiv2"></div>
                                </div>
                            </div>
                            <input type="hidden" id="cropImageHeight2" value="180" />
                            <input type="hidden" id="cropImageWidth2" value="180" />
                        </li>
                        <li>
                            <div style="width:100%;line-height:50px;">
                                <span style="padding-left:10px;">摄像机3</span>
                                <div class="layui-input-inline">
                                    <div style="float:left;width:110px;">
                                        <select name="videoName3" id="videoName3" lay-filter="videoName3">
                                        </select>
                                    </div>
                                </div>
                                <span style="padding-left:3px;">上</span>
                                <div class="layui-input-inline">
                                    <div style="float:left;width:40px;">
                                        <input type="text" name="up3" id="up3" autocomplete="off" class="layui-input" oninput="ChangeUp1(this,3);" />
                                    </div>
                                </div>
                                <span style="padding-left:3px;">下</span>
                                <div class="layui-input-inline">
                                    <div style="float:left;width:40px;">
                                        <input type="text" name="down3" id="down3" autocomplete="off" class="layui-input" oninput="ChangeDown1(this,3);" />
                                    </div>
                                </div>
                                <span style="padding-left:3px;">左</span>
                                <div class="layui-input-inline">
                                    <div style="float:left;width:40px;">
                                        <input type="text" name="left3" id="left3" autocomplete="off" class="layui-input" oninput="ChangeLeft1(this,3);" />
                                    </div>
                                </div>
                                <span style="padding-left:3px;">右</span>
                                <div class="layui-input-inline">
                                    <div style="float:left;width:40px;">
                                        <input type="text" name="right3" id="right3" autocomplete="off" class="layui-input" oninput="ChangeRight1(this,3);" />
                                    </div>
                                </div>
                            </div>
                            <div style="width:100%;text-align:center;">
                                <div id="container3">
                                    <div id="imgDiv3" style="width:95%;margin:0px auto 10px;"></div>
                                    <div id="clipImgDiv3"></div>
                                </div>
                            </div>
                            <input type="hidden" id="cropImageHeight3" value="180" />
                            <input type="hidden" id="cropImageWidth3" value="180" />
                        </li>
                        <li>
                            <div style="width:100%;line-height:50px;">
                                <span style="padding-left:10px;">摄像机4</span>
                                <div class="layui-input-inline">
                                    <div style="float:left;width:110px;">
                                        <select name="videoName4" id="videoName4" lay-filter="videoName4">
                                        </select>
                                    </div>
                                </div>
                                <span style="padding-left:3px;">上</span>
                                <div class="layui-input-inline">
                                    <div style=" float: left; width: 40px;">
                                        <input type="text" name="up4" id="up4" autocomplete="off" class="layui-input" oninput="ChangeUp1(this,4);" />
                                    </div>
                                </div>
                                <span style="padding-left:3px;">下</span>
                                <div class="layui-input-inline">
                                    <div style="float:left;width:40px;">
                                        <input type="text" name="down4" id="down4" autocomplete="off" class="layui-input" oninput="ChangeDown1(this,4);" />
                                    </div>
                                </div>
                                <span style="padding-left:3px;">左</span>
                                <div class="layui-input-inline">
                                    <div style="float:left;width:40px;">
                                        <input type="text" name="left4" id="left4" autocomplete="off" class="layui-input" oninput="ChangeLeft1(this,4);">
                                    </div>
                                </div>
                                <span style="padding-left:3px;">右</span>
                                <div class="layui-input-inline">
                                    <div style="float:left;width:40px;">
                                        <input type="text" name="right4" id="right4" autocomplete="off" class="layui-input" oninput="ChangeRight1(this,4);">
                                    </div>
                                </div>
                            </div>
                            <div style="width:100%;text-align:center;">
                                <div id="container4">
                                    <div id="imgDiv4" style="width:95%;margin:0px auto 10px;"></div>
                                    <div id="clipImgDiv4"></div>
                                </div>
                            </div>
                            <input type="hidden" id="cropImageHeight4" value="180" />
                            <input type="hidden" id="cropImageWidth4" value="180" />
                        </li>
                    </ul>
                    <div class="layui-form-item">
                        <button id="BtnOk" class="layui-btn layui-btn-normal" onclick="BtnOkClick(); ">确认</button>
                        <button id="BtnCancle" class="layui-btn layui-btn-normal" style="margin-left:100px;" onclick="BtnCancel();"> 取消</button>
                    </div>
                </div>
            </div>
        </div>
        <input type="hidden" id="pjStyle" value="2" />
        <input type="hidden" id="pjislock" value="1" />
        <script src="js/jquery-2.1.3.min.js"></script>
        <script src="js/layui/layui.js"></script>
        <script src="js/lodash.min.js"></script>
        <script src="js/Canvas1.js"></script>
        <script src="js/Canvas2.js"></script>
        <!-- <script src="js/Canvas3.js"></script>
        <script src="js/Canvas4.js"></script> -->
        <script src="common.js"></script>
        <script src="webgl.js"></script>
        <script src="player.js"></script>
        <script>
            //var iscrop = false;
            var isThree = false;
            var modifyStyle="/root/out.mp4";
            var apiAddress = "http://192.168.2.76:6036/json";//和鲲鹏对接数据地址
            var videoAddress="http://192.168.2.76/play/";//抓取图片网络地址
            var num = 2;
            var bgwidth = 417;
            var bgheight = 220;
            var image1 = '../images/bg.png';
            var image2 = '../images/bg.png';
            var image3 = '../images/bg.png';
            var image4 = '../images/bg.png';
            var tileArray=[];//只记录当前通道下的所有相机
            var cameras=[];//记录所有通道下的相机
            //var isInit=true;//判断页面是不是初始化
            // var cameraArr=[];
            layui.use(('form'), function () {
                var $ = layui.jquery
                    , form = layui.form;
    
                form.on('select(style)', function (data) {
                    $("#pjStyle").val(data.value);
                    loadJS(data.value);
                    num = parseInt(data.value);
                });
                form.on('select(videoName1)', function (data) {
                    var names=[data.value]
                    GetVideoImgs(names,false,1);
                });
                form.on('select(videoName2)', function (data) {
                    var names=[data.value]
                    GetVideoImgs(names,false,2);
                });
                form.on('select(videoName3)', function (data) {
                    var names=[data.value]
                    GetVideoImgs(names,false,3);
                });
                form.on('select(videoName4)', function (data) {
                    var names=[data.value]
                    GetVideoImgs(names,false,4);
                });
                form.on('select(islock)', function (data) {
                    $("#pjislock").val(data.value);
                });
            });
    
            $(function () {
                GetParams();//获取路径参数
                sendGetTileAjax();
                InitData();//下拉列表绑定摄像头名称
               
                for (var i = 4; i > num; i--) {
                    $("#up" + i).val('').attr("disabled", "disabled");
                    $("#down" + i).val('').attr("disabled", "disabled");
                    $("#left" + i).val('').attr("disabled", "disabled");
                    $("#right" + i).val('').attr("disabled", "disabled")
                }
            });

             function InitCoordinate(num,t,l,d,r)
             {
                 $("#up"+num).val(parseInt(t*bgheight));
                 $("#down"+num).val(parseInt(d*bgheight));
                 $("#left"+num).val(parseInt(l*bgwidth));
                 $("#right"+num).val(parseInt(r*bgwidth));
                 $("#zxxCropBox" + num).css("width",parseInt(r*bgwidth)-parseInt(l*bgwidth));
                 $("#zxxCropBox" + num).css("height",parseInt(d*bgheight)-parseInt(t*bgheight));
                 $("#zxxCropBox" + num).css("top", parseInt(t*bgheight));
                 $("#zxxCropBox" + num).css("left", parseInt(l*bgheight));
             }

                //获取摄像头图片
                window.onload=function()
                {
                    loadJS(num);//根据拼接方式初始化右侧拼接图 num=2/3/4
                    var names=[];
                    for (var i = 1; i <=parseInt(num); i++) {
                         names.push($("#videoName"+i).val());
                    }
                    GetVideoImgs(names,true,-1);  //正式需开启
                }
    
           function GetParams()//如果是修改拼接，需要解析URL传递过来的参数
           {
                var query = window.location.search.substring(1);
                var vars = query.split("&");
                if(vars.length===7)
                {
                    $("#Tname").val(decodeURIComponent(vars[0]).split('=')[1]);
                    $("#TID").val(vars[1].split('=')[1]);
                    $("#playAdd").val(vars[2].split('=')[1]);
                    $("#playPort").val(vars[3].split('=')[1]);
                    $("#state").val(decodeURIComponent(vars[4]).split('=')[1]);
                    $("#style").val(vars[5].split('=')[1]);
                    $("#islock").val(vars[6].split('=')[1]);
                    num=vars[5].split('=')[1];
                    layui.use(['form'], function () {
                    var form = layui.form;
                    form.render();
                   });
                }
           }
            //初始化相机数据，绑定下拉列表
            function InitData() {
                var message = '{"msg":"get_camera_info"}';
                $.ajax({
                    type: "POST",
                    dataType: "text",
                    //url: '/json',
                    url: apiAddress,
                    contentType: "application/json",
                    data: message,
                    //async:false,
                    success: function (result) {
                        var objs = JSON.parse(result);
                        LoadVideo(objs.video_souce_info, 4);
                        layui.use(['form'], function () {
                            var form = layui.form;
                            form.render();
                        });
                    }
                });
              
            }
    
            //绑定相机名称下拉列表 data:数据集合，num：2/3/4
            function LoadVideo(data, num) {
                var parent=$(".layui-row");
                if (num > 0 && typeof(data)!='undefined'&&data!=null&&data!='') {
                    for (var i = 1; i <= num; i++) {
                        var obj = $("#videoName" + i);
                        obj.html('');
                        var str = "";
                        var inputHidden="";
                        var count=0;//记录$.each剔除已使用的相机后循环次数

                        //循环绑定所有通道未使用的相机
                        $.each(data, function (index, item) {
                            if(typeof(item.name)!='undefined' && item.name!=null && item.name!="")
                            {
                                var camera = _.find(cameras, function (obj) { return obj.camera_id == item.camera_id });//已经使用过
                                var camera1= _.find(tileArray, function (obj) { return obj.camera_id == item.camera_id });//此通过也存在
                                if (camera != null && camera1==null) //表示已经使用，不再添加
                                {
                                    return true;
                                }
                                if (count == (i-1))
                                str += "<option value='" + item.camera_id + "' selected>" + item.name + "</option>";
                                else
                                str += "<option value='" + item.camera_id + "'>" + item.name + "</option>";
                                count++;
                            }
                            if (i == 1) //只给第一个绑定，
                            {
                                inputHidden += "<input type='hidden' id='name_" + item.camera_id + "' value='" + item.name + "' />";
                                inputHidden += "<input type='hidden' id='ip_" + item.camera_id + "' value='" + item.ip + "' />";
                                inputHidden += "<input type='hidden' id='address_" + item.camera_id + "' value='" + item.address + "' />";
                                inputHidden += "<input type='hidden' id='port_" + item.camera_id + "' value='" + item.port + "' />";
                                inputHidden += "<input type='hidden' id='state_" + item.camera_id + "' value='" + item.state + "' />";
                            }
                        });
                       
                        $(str).appendTo(obj);
                        $(inputHidden).appendTo(parent);
                    }
                }
            }
    
            //确定事件/***/@@@@@@@@@@@@@@@@@@
            function RequeryCropArray() {
                var messageAll = '{"msg": "start_tile","video_souce_info": [';
                var style = $("#style").val();
                iscrop = true;
                let mess = videoMsg(parseInt(style)); //拼接发送json
                if (!mess) return false;
                messageAll += mess;
                console.log(messageAll);
                sendAjax(messageAll,"set"); //发送拼接，获取拼接视频流
                let TID = $("#TID").val();
                 var gettileinfo='{"msg": "get_tile_info"}';
                //console.log(gettileinfo);
                 sendAjax(gettileinfo,"get");
            }
            //根据选择方式进行canvas处理
            function loadJS(num) {
                $("script[src='js/Canvas4.js']").remove();
                $("#imgDiv4").html('');
                if (num >= "3" && isThree == false) {
                    $("script[src='js/Canvas3.js']").remove();
                    $("#imgDiv3").html('');
                    var head = $("head");
                    var script = $("<script>");
                    $(script).attr('type', 'text/javascript');
                    $(script).attr('src', 'js/Canvas3.js');
                    $(head).append(script);
                    InputDisabled(3);
                    isThree = true;
                }
                if (num === "4") {
                    var head = $("head");
                    var script = $("<script>");
                    $(script).attr('type', 'text/javascript');
                    $(script).attr('src', 'js/Canvas4.js');
                    $(head).append(script);
                    InputDisabled(4);
                }
                if (num === "2") {
                    $("script[src='js/Canvas3.js']").remove();
                    $("#imgDiv3").html('');
                    isThree = false;
    
                }
                //根据选择方式，禁用input
                for (var i = 4; i > parseInt(num); i--) {
                    $("#up" + i).val('').attr("disabled", "disabled");
                    $("#down" + i).val('').attr("disabled", "disabled");
                    $("#left" + i).val('').attr("disabled", "disabled");
                    $("#right" + i).val('').attr("disabled", "disabled")
                    $("#videoName" + i).attr("disabled", "disabled")
                    layui.use(['form'], function () {
                        var form = layui.form;
                        form.render();
                    });
                }
            }
    
            //切换摄像机，加载图片
            function ChangeVideoNmae(img,num) {
                $("#imgDiv" + num).html('');
                if (num == 1) {
                    image1=videoAddress+img;
                    ExecuteCanvas1();
                } else if (num == 2) {
                    image2=videoAddress+img;
                    ExecuteCanvas2();
                } else if (num == 3) {
                    image3=videoAddress+img;
                    ExecuteCanvas3();
                }
                else if (num == 4) {
                    image4=videoAddress+img;
                    ExecuteCanvas4();
                }
                
                   if(tileArray.length>0 && num-1<tileArray.length)//初始化的数量存在和手动选择拼接方式数值不一样
                   {
                    for (let index = 0; index < tileArray.length; index++) {
                                if(tileArray[index].idx_in_tile==(num-1))
                                  InitCoordinate(num,tileArray[index].crop.t,tileArray[index].crop.l,tileArray[index].crop.b,tileArray[index].crop.r);
                            }
                    }
                    
            }
    
            //启用4个方位input
            function InputDisabled(num) {
                $("#up" + num).attr("disabled", false);
                $("#down" + num).attr("disabled", false);
                $("#left" + num).attr("disabled", false);
                $("#right" + num).attr("disabled", false);
                $("#videoName" + num).attr("disabled", false)
                layui.use(['form'], function () {
                    var form = layui.form;
                    form.render();
                });
            }
    
            //根据方位input输入，移动截取框
            function ChangeUp1(e, xh) {
                var value = parseInt(e.value);
                var height = ID("zxxCropBox" + xh).clientHeight;
                if (value + height <= bgheight) {
                    $("#zxxCropBox" + xh).css("top", parseInt(e.value));
                    $("#down" + xh).val(parseInt(e.value) + height);
                }
            }
            function ChangeDown1(e, xh) {
                var value = parseInt(e.value);
                var height = ID("zxxCropBox" + xh).clientHeight;
                if (value <= bgheight && e.value >= height) {
                    var top = parseInt(e.value) - height;
                    $("#zxxCropBox" + xh).css("top", top);
                    $("#up" + xh).val(top);
                }
            }
            function ChangeLeft1(e, xh) {
                var value = parseInt(e.value);
                var width = ID("zxxCropBox" + xh).clientWidth;
                if (value + width <= bgwidth) {
                    var left = value + width;
                    $("#zxxCropBox" + xh).css("left", parseInt(e.value));
                    $("#right" + xh).val(left);
                }
            }
            function ChangeRight1(e, xh) {
                var value = parseInt(e.value);
                var width = ID("zxxCropBox" + xh).clientWidth;
                if (value <= bgwidth && value > width) {
                    var left = bgwidth - width;
                    $("#zxxCropBox" + xh).css("left", left);
                    $("#left" + xh).val(left);
                }
            }
         
            var names=[];
            function GetVideoImgs(names,init,num) {
                var style=parseInt($("#style").val());
                if(names.length<=0)
                return false;
                for (let index = 1; index <= names.length; index++) {
                       var message = '{"msg": "set_camera_info","video_souce_info": [';
                        message += '{';
						 if(typeof(names[index-1])=='undefined' || names[index-1]=="" | names[index-1]==null)
                         return true;
                         message += '"camera_id":"' + names[index-1] + '",';
                        // message+='"urlorfile":"/root/1.264",';
                       // message+='"urlorfile":"'+modifyStyle+'",';
                       //message += '"urlorfile":"udp://' + $("#address_"+names[index-1]).val() + ':' +$("#port_"+names[index-1]).val() + '",';
                       var cam_ip=$("#ip_"+names[index-1]).val();
                        if(typeof(cam_ip)=='undefined' || cam_ip==null || cam_ip=="")
                        {
                            message += '"urlorfile":"udp://' + $("#address_"+names[index-1]).val() + ':' +$("#port_"+names[index-1]).val() + '",';
                        }
                        else
                        {
                            message += '"urlorfile":"rtsp://admin:admin12345@' + $("#ip_"+names[index-1]).val() +'",';
                        }
                        message += '"name":"' + $("#name_"+names[index-1]).val() + '",';
                        message += '"ip":"' + $("#ip_"+names[index-1]).val() + '",';
                        message += '"address":"' + $("#address_"+names[index-1]).val() + '",';
                        message += '"port":"' + $("#port_"+names[index-1]).val() + '",';
                        message += '"state":"' + $("#state_"+names[index-1]).val() + '"';
                        message += '}';    
                       message += "]}";
                       console.log(message);
                   $.ajax({
                    type: "POST",
                    dataType: "text",
                    //url: '/json',
                    url: apiAddress,
                    contentType: "application/json",
                    data: message,
                    timeout: 7000,
                    //  async:false,
                    success: function (result) {
                        if (result != "") {
                            console.log(result);
                            var objs = JSON.parse(result);
                               if(index==names.length){
                                var send_str = '{"msg": "cap_pic","camera_id":' + JSON.stringify(names) + '}';
                                console.log(send_str);
                                GetCameraImage(send_str,init,num);
                               } 
                        }
                    }
                });
            }
            }
    
           function GetCameraImage(message,init,num)
           {
               $.ajax({
                        type: "POST",
                        dataType: "text",
                        //url: '/json',
                        url: apiAddress,
                        contentType: "application/json",
                        data: message,
                        timeout: 5000,
                        async: false,
                        success: function (result) {
                            if (result != "") {
                                console.log(result);
                                var objs = JSON.parse(result);
                                if (objs.pics.length > 0) {
                                    for (let index = 1; index <= objs.pics.length; index++) {
                                        if(num<0)
                                          ChangeVideoNmae(objs.pics[index-1].pic_url,index); 
                                          else
                                          ChangeVideoNmae(objs.pics[0].pic_url,num); 
                                    }
                                    if(init) {RequeryCropArray();}
                                }
                            }
                        }
                });
           }

    
            //拼接发送信息  playCanvas
            let videoMsg = function (num) {
                let Tname = $("#Tname").val();
                let TID = $("#TID").val();
                let address = $("#playAdd").val();
                let islock = $("#islock").val();
                let port = $("#playPort").val();
                var style = $("#style").val();
                let messgae = "";
                if (typeof (Tname) === "undefined" || Tname === "" || Tname === null) { layer.msg('请输入拼接通道名称'); return false; }
                if (typeof (TID) === "undefined" || TID === "" || TID === null) { layer.msg('请输入通道ID'); return false; }
                if (typeof (address) === "undefined" || address === "" || address === null) { layer.msg('请输入组播地址'); return false; }
                if (typeof (port) === "undefined" || port === "" || port === null) { layer.msg('请输入组播端口'); return false; }
                if (num > 0) {
                    for (var i = 1; i <= num; i++) {
                        var msg = "{";
                        let videoName = $("#videoName" + i).val();
                        let up = $("#up" + i).val();
                        let down = $("#down" + i).val();
                        let left = $("#left" + i).val();
                        let right = $("#right" + i).val();
                        //转换0-1坐标
                        up = parseInt(up) / bgheight;
                        down = parseInt(down) / bgheight;
                        left = parseInt(left) / bgwidth;
                        right = parseInt(right) / bgwidth;
                        msg += '"camera_id": "' + videoName + '",';
                       // msg += '"urlorfile":"udp://' + $("#address_"+videoName).val() + ':' +$("#port_"+videoName).val() + '",';
                       var cam_ip = $("#ip_" + videoName).val();
                        if (typeof (cam_ip) == 'undefined' || cam_ip == null || cam_ip == '') {
                            msg += '"urlorfile":"udp://' + $("#address_"+videoName).val() + ':' +$("#port_"+videoName).val() + '",';
                        } else {
                            msg += '"urlorfile":"rtsp://admin:admin12345@' + $("#ip_" + videoName).val() + '",';
                        }
                        //msg += '"urlorfile": "udp://' + address + ':' + port + '",';
                        //msg+='"urlorfile":"'+modifyStyle+'",';
                        //msg+='"urlorfile":"/root/1.264",';
                        msg += '"vendor": 1,';
                        msg += '"crop": { "l":' + left + ',"t":' + up + ',"r":' + right + ',"b":' + down + '},';
                        msg += '"tile_video_id":"'+TID+'",';
                        msg += '"idx_in_tile":' + (i - 1) + '},';
                        messgae += msg;
                    }
                    messgae = messgae.substring(0, messgae.length - 1) + "],";
                    // messageAll += messgae;
                }
                messgae += '"video_tile": [{';
                messgae += '"ip": "'+TID+'",';
                messgae += '"name": "' + Tname + '",';
                messgae += '"address": "' + address + '",';
                messgae += '"port": "' + port + '",';
                messgae += '"style": ' + style + ',';
                messgae += '"state": 1,';
                messgae += '"islock":' + parseInt(islock) + ',';
                messgae += '"id": "'+TID+'",';
                messgae += '"fix_1080p":' + parseInt(islock) + ',';
                messgae += '"multicast_ip":"'+address+'",';
                messgae += '"multicast_port":'+port+' }]';
                messgae += "}";
                return messgae;
            }
    
            //发送ajax，获取拼接流地址信息，拼接视频播放
            function sendAjax(send_str,action) {
                $.ajax({
                    type: "POST",
                    dataType: "text",
                    //url: '/json',
                    url: apiAddress,
                    contentType: "application/json",
                    data: send_str,
                    async:false,
                    timeout: 10 * 1000,
                    success: function (result) {
                        console.log(result);
                        if(action==='get'){
                            var objs= JSON.parse(result);
                            if(objs.video_tile.length>0)
                            {
                                for (let index = 0; index < objs.video_tile.length; index++) {
                                   if(objs.video_tile[index].id===$("#TID").val())
                                    {
                                        $("#pj_width").val(objs.video_tile[index].w);
                                        $("#pj_height").val(objs.video_tile[index].h);
                                        playVideo();
                                    }
                                }
                            }
                          
                        }else if(action==='set')
                        {
                           // console.log(result);
                        }
                    }
                });
            }
    
            //播放视频
            function playVideo(osd) {
                var domain = document.domain;
                var domain = "likp.top";
                var canvas = document.getElementById("playCanvas");
                if (!canvas) {
                    return false;
                }
                if (!document.player) {
                    document.player = new Player();
                }
                //var playAdd = "tstream://"+id;
                var playAdd = "tstream://"+$("#TID").val();
                document.player.play(domain, playAdd, canvas);
                return true;
            }
    
            //停止播放
            function stopVideo() {
                var canvas = document.getElementById("playCanvas");
                document.player.stop();
            }
            //点击取消事件，摄像头1，2重置， 注意：num为全局变量
            function BtnCancel() {
                // isThree = false;
                // //主要取消1，2的效果
                // for (var i = 1; i <= 2; i++) {
                //     var head = $("head");
                //     var script = $("<script>");
                //     $("script[src='js/Canvas" + i + ".js']").remove();
                //     $("#imgDiv" + i + "").html('');
                //     $(script).attr('type', 'text/javascript');
                //     $(script).attr('src', 'js/Canvas' + i + '.js');
                //     $(head).append(script);
                // }
                // loadJS(num);//注销3，4效果
            }
    
            
            function sendGetTileAjax() {
          var send_str='{"msg": "get_tile_info"}';
          console.log(send_str);
                $.ajax({
                    type: "POST",
                    dataType: "text",
                    //url: '/json',
                    url: apiAddress,
                    contentType: "application/json",
                    data: send_str,
                    timeout: 5000,
                    //async:false,
                    success: function (result) {
                        //console.log(result);
                        var objs = JSON.parse(result);
                         if(objs!=null&&typeof(objs)!='undefined')
                         {
                             for(var i=0;i<objs.video_souce_info.length;i++)
                             {
                                 if($("#TID").val()==objs.video_souce_info[i].tile_video_id)
                                 tileArray.push(objs.video_souce_info[i]);
                             }
                             cameras=objs.video_souce_info;
                         }
                    }
                });
            }

            function BtnOkClick()
            {
                var flag = JudgeCamID();
                if (!flag) { layer.msg("不能有重复的摄像机！"); return false; }
                var style = $("#style").val();
                var messageAll = '{"msg": "start_tile","video_souce_info": [';

                iscrop = true;
                let mess = videoMsg(parseInt(style)); //拼接发送json
                if (!mess) return false;
                messageAll += mess;
                console.log(messageAll);
                sendAjax(messageAll, "set"); //发送拼接，获取拼接视频流
                stopVideo();
                let TID = $("#TID").val();
                var gettileinfo = '{"msg": "get_tile_info"}';
                console.log(gettileinfo);
                sendAjax(gettileinfo, "get");      
            }

            function JudgeCamID() {
                    var style = $("#style").val();
                    if (parseInt(style) > 0) {
                        var cam_id = "";
                        for (let index = 1; index <= parseInt(style); index++) {
                            if (cam_id.indexOf($("#videoName" + index).val()) >= 0) {
                                return false;
                            }
                            else
                                cam_id += $("#videoName" + index).val()+",";
                        }
                        return true;
                    }
                }

                function ModifyOSDsTYLE()
                {
                    $("#osd").css("display","block");
                    moveOSD();
                }
            
          var moveOSD = function () {
                //获取元素
                var dv = document.getElementById('osd');
                var x = 0;
                var y = 0;
                var l = 0;
                var t = 0;
                //鼠标按下事件
                dv.onmousedown = function (event) {
                    let e = event ? event : window.event;
                    //获取x坐标和y坐标
                    var x = e.clientX; // 鼠标移动时x坐标
                    var y = e.clientY;   // 鼠标移动时y坐标

                    //获取左部和顶部的偏移量
                   l = dv.offsetLeft;
                    t = dv.offsetTop;
                    //开关打开
                    isDown = true;
                    //设置样式  
                    dv.style.cursor = 'move';
                    //鼠标移动
                    document.onmousemove = function (e) {
                        if (isDown == false) {
                            return;
                        }

                        var nx = e.clientX;
                        var ny = e.clientY;
                        var clientx=parseInt(ID("osd").clientWidth);
                        var clientY=parseInt(ID("osd").clientHeight);
                        //计算移动后的左偏移量和顶部的偏移量
                        var nl = nx - (x - l);
                        var nt = ny - (y - t);
                        if(nl<0)
                        nl=0;
                        else if(nl+clientx>519)
                        nl=519-clientx;
                        if(nt<0)
                        nt=0;
                        else if(nt+clientY>260)
                        nt=260-clientY;
                        dv.style.left = nl + 'px';
                        dv.style.top = nt + 'px';
                    }
                    //鼠标抬起事件
                    document.onmouseup = function () {
                        // dv.onmousedown=null;
                        // dv.onmousemove=null;
                        //开关关闭
                        isDown = false;
                        dv.style.cursor = 'default';
                    }
                }

            }

            function SendOSD()
            {
                var obj=document.getElementById("txtOSD");//获取文本框字体大小
                var top=parseInt(getCss(ID("osd"), "top"));
                var left=parseInt(getCss(ID("osd"), "left"));
                //实际top值为：top+input-fontsize   parseInt(obj.style.fontSize)
                var send_str='{"msg":"set_tile_osd",';
                if($("#pj_width").val()=="" || $("#pj_height").val()=="")
                { 
                    layer.msg('请先进行摄像机拼接');return false;
                }
                var videoX= parseInt( $("#pj_width").val());
                var videoY=  parseInt($("#pj_height").val());
                left=parseInt(left)/520;
                top=parseInt(top)/260;
                 var fontSize=Math.ceil( Math.round(parseInt(videoX)/520,2)*20);  
fontSize=fontSize<100?fontSize:100;
                send_str+='"tile_id":"'+$("#TID").val()+'","txt":"'+obj.innerText+'","x":'+left+',"y":'+top+',"ft_size":'+fontSize+'}';
                console.log(send_str);
                sendAjax(send_str,"osd");
                var gettileinfo = '{"msg": "get_tile_info"}';
                console.log(gettileinfo);
                sendAjax(gettileinfo, "get");
                $("#osd").css("display","none");
            } 


        </script>
    </body>
    </html>